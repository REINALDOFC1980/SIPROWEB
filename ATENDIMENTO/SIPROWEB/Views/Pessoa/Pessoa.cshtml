

<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>Tela Pessoa</h2>
        <small>Dados de pessoas cadastrada no protocolo</small>
       
    </div>
    <div class="col-lg-2">
    </div>
</div>

<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row justify-content-center">
        <!-- Adiciona a classe justify-content-center para centralizar a div col-lg-3 -->
        <div class="col-lg-6">
       @*      <div class="alert alert-warning text-center">
                <i class="fa fa-twitch"></i> CPF não encontrado na base de dados do Protocolo. <br />Verifique se foi digitado corretamente ou realize o cadastro.
            </div> *@
            <div class="modal-body">
                <form role="formpessoa" id="formpessoa">
                    <input type="hidden" id="PES_ID" name="PES_ID" required>
                @*     <div class="row">
                        <div class="form-group col-md-12"><label> <input type="checkbox" id="Pes_Estrangeiro" name="Pes_Estrangeiro"> Se for estrangeiro favor marcar!</label></div>
                    </div> *@
                    <div class="row">
                        <div class="form-group col-md-4">
                            <label>Digite o número do CPF</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="PES_CPF" name="PES_CPF" data-mask="000.000.000-00" required maxlength="11">
                                <span class="input-group-append">
                                    <button type="button" class="btn btn-primary" id="btnbuscar_condutor">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </span>
                            </div>
                            <span class="error-cpf" style="color:chocolate;"></span>
                        </div>
                        <div class="form-group col-md-8">
                            <label>Nome</label>
                            <input type="text" placeholder="" class="form-control" id="PES_Nome" name="PES_Nome" required maxlength="50">
                        </div>
                    </div>

                    <div class="row">
                        <div class="form-group col-md-5"><label>CNH</label><input type="text" placeholder="" class="form-control" data-mask="00000000000" id="PES_NumRegistroCNH" name="PES_NumRegistroCNH"></div>
                        <div class="form-group col-md-5">
                            <label>Validade CNH</label><input type="text" placeholder="" data-mask="99/99/9999" class="form-control" id="PES_DT_Validade" name="PES_DT_Validade">
                            <span class="error-cnh" style="color:chocolate;"></span>
                        </div>
                        <div class="form-group col-md-2"><label>UF CNH</label><input type="text" placeholder="" class="form-control input-mixed" id="PES_UFCNH" name="PES_UFCNH" maxlength="2"></div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-6"><label>Email</label><input type="email" placeholder="" class="form-control" id="PES_Email" name="PES_Email"></div>
                        <div class="form-group col-md-3"><label>Celular</label><input type="text" placeholder="" data-mask="(00)00000-0000" class="form-control" id="PES_Celular" name="PES_Celular" required minlength="14"></div>
                        <div class="form-group col-md-3"><label>Telefone</label><input type="text" placeholder="" data-mask="(00)00000-0000" class="form-control" id="PES_Telefone" name="PES_Telefone" minlength="14"></div>
                    </div>

                    <hr />
                    <div class="row">
                        <div class="form-group col-md-3">
                            <label>Cep</label><input type="text" placeholder="" class="form-control input-zip" data-mask="99.999-999" id="PES_EndCEP" name="PES_EndCEP" required>
                            <span class="error-cep" style="color: chocolate;"></span>
                        </div>

                        <div class="form-group col-md-5"><label>Logradouro</label><input type="text" placeholder="" class="form-control" id="PES_EndLogradouro" name="PES_EndLogradouro" required maxlength="50"></div>
                        <div class="form-group col-md-4"><label>Bairro</label><input type="text" placeholder="" class="form-control input-mixed" id="PES_EndBairro" name="PES_EndBairro" required maxlength="30"></div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-3"><label>Município</label><input type="text" placeholder="" class="form-control" id="PES_Municipio" name="PES_Municipio" required maxlength="20"></div>
                        <div class="form-group col-md-2"><label>UF</label><input type="text" placeholder="" class="form-control" id="PES_UF" name="PES_UF" required maxlength="2"></div>
                        <div class="form-group col-md-2"><label>Número</label><input type="text" placeholder="" class="form-control" id="PES_EndNumero" name="PES_EndNumero" required maxlength="5"></div>
                        <div class="form-group col-md-5"><label>Complemento</label><input type="text" placeholder="" class="form-control" id="PES_EndComplemento" name="PES_EndComplemento" maxlength="30"></div>
                    </div>
                </form>
          

     

                <div class="row">
                    <div class="col-md-8 text-left">
                        <small>
                            <i class="fa fa-twitch"></i> Todas as informações cadastradas são de responsabilidade do atendente. Agradecemos sua compreensão e colaboração.
                        </small>
                    </div>
                    <div class="col-md-4 text-right">
                        <button type="button" class="btn btn-default" id="btnNovo"> Novo </button>
                        <button type="button" class="btn btn-primary" id="btnCadastrarPessoa"> Gravar </button>
                    </div>

                </div>

            </div>
            
        </div>
    </div>
</div>






<script src="~/js/jquery-3.1.1.min.js"></script>
<script src="~/js/jquery.min.js"></script>
<script src="~/js/bootstrap.min.js"></script>
<script src='~/js/jquery.mask.min.js'></script>
<script src="~/js/validadorcpf.js"></script>
<script src="~/js/validadordtcnh.js"></script>
<script src="~/js/validacaoFormPessoa.js"></script>
<script src="~/js/BuscarCep.js"></script>
<script src="~/js/IconeErro.js"></script>
<script src="~/js/valorzeroesquerda.js"></script>

<script src="~/js/notiflix-aio-2.1.3.min.js"></script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>

    let isProcessing = false;
    $('#PES_CPF').blur(function () {
        buscarcondutor();
    });

    async function buscarcondutor() {
        let cpf = $('#PES_CPF').val();
        cpf = cpf.replace(/\D/g, '');
        $("#PES_CPF").val(cpf);

        if (cpf.length !== 11 || !validarCPF(cpf)) {
            Addiconeerro(".error-cpf", " CPF Inválido!");
            $('#PES_CPF').focus();
            return;
        } else {
            Removeiconeerro(".error-cpf");
        }

        Notiflix.Loading.Standard('Aguarde...');

        try {
            // Corrija a origem do valor de `movpro_id` (ajuste conforme sua lógica)
            const valor = $('#movpro_id').val(); // Exemplo
            const response = await fetch(`@Url.Action("GetPessoa", "Pessoa")?cpf=${cpf}`);
            const data = await response.json();

            if (!response.ok) {
                if (data.redirectTo) {
                    window.location.href = data.redirectTo;
                } else {
                    Notiflix.Notify.Failure(data.message || 'Erro inesperado.');
                }
                return;
            }

            if (data.pessoaModel) {
                let p = data.pessoaModel;
                $("#PES_ID").val(p.pes_ID);
                $("#PES_Celular").val(p.pes_Celular);
                $("#PES_DT_Validade").val(p.pes_DT_Validade);
                $("#PES_DataCadastro").val(p.pes_DataCadastro);
                $("#PES_Email").val(p.pes_Email);
                $("#PES_EndBairro").val(p.pes_EndBairro);
                $("#PES_EndCEP").val(p.pes_EndCEP);
                $("#PES_EndComplemento").val(p.pes_EndComplemento);
                $("#PES_EndLogradouro").val(p.pes_EndLogradouro);
                $("#PES_EndNumero").val(p.pes_EndNumero);
                $("#PES_Municipio").val(p.pes_Municipio);
                $("#PES_Nome").val(p.pes_Nome);
                $("#PES_NomeFantasia").val(p.pes_NomeFantasia);
                $("#PES_NumRegistroCNH").val(p.pes_NumRegistroCNH);
                $("#PES_RG").val(p.pes_RG);
                $("#PES_Telefone").val(p.pes_Telefone);
                $("#PES_Tipo").val(p.pes_Tipo);
                $("#PES_UF").val(p.pes_UF);
                $("#PES_UFCNH").val(p.pes_UFCNH);
                $("#PES_Pais").val(p.pes_Pais);
            } else {
                Notiflix.Notify.Warning(data.message || 'Pessoa não encontrada.');
                $('#formpessoa input, #formpessoa textarea').val('');
                $("#PES_CPF").val(cpf);
                $("#PES_Nome").focus();
            }

        } catch (error) {
            Notiflix.Notify.Failure('Erro de comunicação com o servidor.');
            console.error(error);
        } finally {
            Notiflix.Loading.Remove();
        }
    }

    //Btm=n de cadastro de Usuario caso não tenha!
    $('#btnNovo').click(function () {
        $('#formpessoa input').val('');
        $('#formpessoa textarea').val('');
        $("#PES_CPF").focus();
    });
      
    //buscar o CEP
    $('#PES_EndCEP').blur(function () {
        Notiflix.Loading.Standard('Aguarde...');
        BuscarCep($(this).val());
    });

    //Btm=n de cadastro de Usuario caso não tenha!

    $(document).on('click', '#btnCadastrarPessoa', async function () {

        if (isProcessing) return;
        isProcessing = true;

        ValidacaoFormPessoa("#formpessoa");

        if ($("#formpessoa").valid()) {

            var formData = new FormData($('#formpessoa')[0]);

            Notiflix.Loading.Standard('Aguarde...');

            try {
                const response = await fetch('@Url.Action("CadastrarPessoa", "Pessoa")', {
                        method: 'POST',
                        body: formData,          
                });
                
                const data = await response.json();

                Notiflix.Loading.Remove();

                // ❌ ERRO
                if (!response.ok) {
                    
                    isProcessing = false;               
                    if (data.redirectTo) {
                        window.location.href = data.redirectTo; //Erros 500 e NotFoud
                    } else {
                        Notiflix.Notify.Failure(data.message); //Erros 400 outros
                    }
                    return false;
                }

                // ✅ OK
              
                isProcessing = false;
                Notiflix.Notify.Success(data.message);

            } catch (error) {
                isProcessing = false;
                Notiflix.Notify.Failure(error);
                Notiflix.Loading.Remove();
            }



        }
    });


</script>



